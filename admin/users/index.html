<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Users Management - Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding: 20px 0;
      }
      .container {
        max-width: 1400px;
      }
      .page-header {
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .page-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
      }
      .users-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }
      .users-table table {
        margin-bottom: 0;
      }
      .users-table thead {
        background-color: #f1f3f5;
        border-bottom: 2px solid #dee2e6;
      }
      .users-table th {
        padding: 16px 12px;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
        font-size: 12px;
        letter-spacing: 0.5px;
      }
      .users-table td {
        padding: 14px 12px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
      }
      .users-table tbody tr:hover {
        background-color: #f8f9fa;
      }
      .badge-verified {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }
      .badge-unverified {
        background-color: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }
      .badge-role {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
      }
      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
      }
      .spinner-border {
        width: 40px;
        height: 40px;
      }
      .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 12px 20px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin-bottom: 20px;
      }
      .email-text {
        word-break: break-all;
        max-width: 250px;
      }
      .mobile-text {
        font-family: monospace;
        font-weight: 500;
      }
      .date-text {
        font-size: 13px;
        color: #6c757d;
        white-space: nowrap;
      }
      .no-users {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
      }
      .no-users p {
        font-size: 16px;
        margin-bottom: 0;
      }
      .fw-600 {
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="page-header">
        <div>
          <h1>üë• Users Management</h1>
          <p class="text-muted mt-2">View and manage all registered users</p>
        </div>
      </div>

      <!-- Date Range Filters -->
      <div
        class="card mb-4"
        style="
          border: 1px solid #dee2e6;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        "
      >
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-md-4">
              <label for="startDate" class="form-label fw-600"
                >Start Date</label
              >
              <input type="date" id="startDate" class="form-control" />
            </div>
            <div class="col-md-4">
              <label for="endDate" class="form-label fw-600">End Date</label>
              <input type="date" id="endDate" class="form-control" />
            </div>
            <div class="col-md-4">
              <button id="filterBtn" class="btn btn-primary w-100">
                üîç Filter Users
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Error Message (Hidden by default) -->
      <div id="errorMessage" class="error-message" style="display: none"></div>

      <!-- Users Table -->
      <div class="users-table">
        <div id="loadingSpinner" class="loading-spinner">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <div id="tableContent" style="display: none">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Mobile</th>
                  <th>Email Verified</th>
                  <th>Mobile Verified</th>
                  <th>Roles</th>
                  <th>Created At</th>
                  <th>Updated At</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- Users will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </div>
        <div id="noUsersMessage" style="display: none">
          <div class="no-users">
            <p>No users found</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/js/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>

    <script>
      // Helper function to format date
      function formatDate(dateString) {
        if (!dateString) return "-";
        try {
          const date = new Date(dateString);
          return date.toLocaleString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        } catch (e) {
          return dateString;
        }
      }

      async function loadUsers(startDate = "", endDate = "") {
        try {
          const loadingSpinner = document.getElementById("loadingSpinner");
          const tableContent = document.getElementById("tableContent");
          const noUsersMessage = document.getElementById("noUsersMessage");
          const errorMessage = document.getElementById("errorMessage");
          const usersTableBody = document.getElementById("usersTableBody");

          // Show loading spinner
          loadingSpinner.style.display = "flex";
          tableContent.style.display = "none";
          noUsersMessage.style.display = "none";
          errorMessage.style.display = "none";

          // Build query parameters
          let queryParams = new URLSearchParams();
          if (startDate) queryParams.append("startDate", startDate);
          if (endDate) queryParams.append("endDate", endDate);
          const queryString = queryParams.toString();

          // Fetch users from API with query parameters
          const response = await fetch(
            `${BASE_URL}/api/v1/admin/get-all-users${
              queryString ? "?" + queryString : ""
            }`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          ).then((res) => res.json());

          if (response.status === 200 && response.data) {
            const users = response.data;

            if (users.length === 0) {
              loadingSpinner.style.display = "none";
              noUsersMessage.style.display = "block";
              return;
            }

            // Populate table
            usersTableBody.innerHTML = users
              .map(
                (user, index) => `
            <tr>
              <td>${index + 1}</td>
              <td>
                <strong>${user.name || "-"}</strong>
              </td>
              <td>
                <span class="email-text">${user.email || "-"}</span>
              </td>
              <td>
                <span class="mobile-text">${user.mobile || "-"}</span>
              </td>
              <td>
                ${
                  user.isEmailVerified
                    ? '<span class="badge-verified">‚úì Verified</span>'
                    : '<span class="badge-unverified">‚úó Unverified</span>'
                }
              </td>
              <td>
                ${
                  user.isMobileVerified
                    ? '<span class="badge-verified">‚úì Verified</span>'
                    : '<span class="badge-unverified">‚úó Unverified</span>'
                }
              </td>
              <td>
                ${
                  user.roles && user.roles.length > 0
                    ? user.roles
                        .map(
                          (role) => `<span class="badge-role">${role}</span>`
                        )
                        .join(" ")
                    : "-"
                }
              </td>
              <td>
                <span class="date-text">${
                  formatDate(user.createdAt) || "-"
                }</span>
              </td>
              <td>
                <span class="date-text">${
                  formatDate(user.updatedAt) || "-"
                }</span>
              </td>
            </tr>
          `
              )
              .join("");

            loadingSpinner.style.display = "none";
            tableContent.style.display = "block";
          } else {
            throw new Error(response.message || "Failed to fetch users");
          }
        } catch (error) {
          console.error("Error loading users:", error);
          const loadingSpinner = document.getElementById("loadingSpinner");
          const errorMessage = document.getElementById("errorMessage");

          loadingSpinner.style.display = "none";
          errorMessage.style.display = "block";
          errorMessage.innerText = `Error: ${
            error.message || "Failed to load users. Please try again."
          }`;
        }
      }

      // Load users on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadUsers();

        // Add filter button event listener
        document.getElementById("filterBtn").addEventListener("click", () => {
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;
          loadUsers(startDate, endDate);
        });

        // Allow Enter key to trigger filter
        document
          .getElementById("startDate")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") document.getElementById("filterBtn").click();
          });
        document.getElementById("endDate").addEventListener("keypress", (e) => {
          if (e.key === "Enter") document.getElementById("filterBtn").click();
        });
      });
    </script>
  </body>
</html>
